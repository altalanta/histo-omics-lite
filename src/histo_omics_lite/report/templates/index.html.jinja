<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ experiment_name }} - Results Report</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            line-height: 1.6;
            color: #333;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f8f9fa;
        }
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 10px;
            margin-bottom: 30px;
            text-align: center;
        }
        .header h1 {
            margin: 0;
            font-size: 2.5em;
        }
        .header p {
            margin: 10px 0 0 0;
            opacity: 0.9;
        }
        .section {
            background: white;
            padding: 25px;
            margin-bottom: 25px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .section h2 {
            color: #2c3e50;
            border-bottom: 2px solid #3498db;
            padding-bottom: 10px;
            margin-top: 0;
        }
        .section h3 {
            color: #34495e;
            margin-top: 25px;
        }
        .metrics-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }
        .metrics-table th, .metrics-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        .metrics-table th {
            background-color: #f8f9fa;
            font-weight: 600;
            color: #2c3e50;
        }
        .metrics-table tr:hover {
            background-color: #f5f5f5;
        }
        .badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8em;
            font-weight: 500;
        }
        .badge-success {
            background-color: #d4edda;
            color: #155724;
        }
        .badge-warning {
            background-color: #fff3cd;
            color: #856404;
        }
        .badge-info {
            background-color: #d1ecf1;
            color: #0c5460;
        }
        .image-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        .image-card {
            text-align: center;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            background: white;
        }
        .image-card img {
            max-width: 100%;
            height: auto;
            border-radius: 4px;
        }
        .image-card h4 {
            margin: 10px 0 5px 0;
            color: #2c3e50;
        }
        .metadata {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
        }
        .footer {
            text-align: center;
            padding: 20px;
            color: #6c757d;
            border-top: 1px solid #dee2e6;
            margin-top: 40px;
        }
        .links {
            margin: 20px 0;
        }
        .links a {
            display: inline-block;
            padding: 10px 20px;
            margin: 5px;
            background-color: #3498db;
            color: white;
            text-decoration: none;
            border-radius: 5px;
            transition: background-color 0.2s;
        }
        .links a:hover {
            background-color: #2980b9;
        }
        .summary-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        .stat-card {
            background: linear-gradient(45deg, #f093fb 0%, #f5576c 100%);
            color: white;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
        }
        .stat-card h3 {
            margin: 0;
            font-size: 2em;
            color: white;
        }
        .stat-card p {
            margin: 5px 0 0 0;
            opacity: 0.9;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>{{ experiment_name }}</h1>
        <p>Histology-Omics Alignment Benchmark Report</p>
        <p>Generated on {{ timestamp }} | Version {{ version }} | Git SHA: {{ git_sha }}</p>
    </div>

    <!-- Summary Section -->
    <div class="section">
        <h2>📊 Summary</h2>
        <div class="summary-stats">
            <div class="stat-card">
                <h3>{{ dataset.n_samples }}</h3>
                <p>Total Samples</p>
            </div>
            <div class="stat-card">
                <h3>{{ dataset.n_classes }}</h3>
                <p>Classes</p>
            </div>
            <div class="stat-card">
                <h3>{{ dataset.n_genes }}</h3>
                <p>Genes</p>
            </div>
            <div class="stat-card">
                <h3>{{ models|length }}</h3>
                <p>Models Evaluated</p>
            </div>
        </div>
    </div>

    <!-- Dataset Card -->
    <div class="section">
        <h2>📋 Dataset Information</h2>
        <div class="metadata">
            <strong>Name:</strong> {{ dataset.name }}<br>
            <strong>Description:</strong> {{ dataset.description }}<br>
            <strong>License:</strong> {{ dataset.license }}<br>
            <strong>Classes:</strong> {{ dataset.classes|join(', ') }}<br>
            <strong>Image Size:</strong> {{ dataset.tile_size }}<br>
            <strong>Splits:</strong> Train {{ "%.0f"|format(dataset.splits.train * 100) }}% | 
                                    Val {{ "%.0f"|format(dataset.splits.val * 100) }}% | 
                                    Test {{ "%.0f"|format(dataset.splits.test * 100) }}%
        </div>
    </div>

    <!-- Benchmark Results -->
    <div class="section">
        <h2>🎯 Benchmark Results</h2>
        <p>Performance comparison across different model architectures with 95% confidence intervals.</p>
        
        <table class="metrics-table">
            <thead>
                <tr>
                    <th>Model</th>
                    <th>AUROC</th>
                    <th>AUPRC</th>
                    <th>ECE</th>
                    <th>Status</th>
                </tr>
            </thead>
            <tbody>
                {% for model in models %}
                <tr>
                    <td><strong>{{ model.name }}</strong></td>
                    <td>{{ model.metrics.auroc_formatted }}</td>
                    <td>{{ model.metrics.auprc_formatted }}</td>
                    <td>{{ "%.3f"|format(model.metrics.ece) }}</td>
                    <td>
                        {% if model.metrics.auroc > 0.8 %}
                            <span class="badge badge-success">Excellent</span>
                        {% elif model.metrics.auroc > 0.7 %}
                            <span class="badge badge-info">Good</span>
                        {% else %}
                            <span class="badge badge-warning">Needs Improvement</span>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Model Card -->
    <div class="section">
        <h2>🤖 Model Information</h2>
        <h3>Architecture Overview</h3>
        <ul>
            <li><strong>Vision Encoder:</strong> ResNet18 (512-dim features)</li>
            <li><strong>Omics Encoder:</strong> 2-layer MLP ({{ dataset.n_genes }}→256→128-dim)</li>
            <li><strong>Contrastive Learning:</strong> InfoNCE objective with temperature scaling</li>
            <li><strong>Training:</strong> {{ training.max_epochs }} epochs, batch size {{ training.batch_size }}</li>
        </ul>

        <h3>Baseline Models</h3>
        <ul>
            <li><strong>Image-only Linear Probe:</strong> Frozen ResNet18 + linear classifier</li>
            <li><strong>Omics-only MLP:</strong> Multi-layer perceptron with batch normalization</li>
            <li><strong>Early Fusion:</strong> Concatenated features before final classification</li>
            <li><strong>Late Fusion:</strong> Combined predictions from separate pathways</li>
            <li><strong>CLIP Alignment:</strong> Contrastive learning between modalities</li>
        </ul>
    </div>

    <!-- Visualizations -->
    <div class="section">
        <h2>📈 Visualizations</h2>
        
        <div class="image-grid">
            {% if plots.calibration %}
            <div class="image-card">
                <h4>Calibration Plot</h4>
                <img src="{{ plots.calibration }}" alt="Calibration Plot">
                <p>Model calibration and reliability curve</p>
            </div>
            {% endif %}

            {% if plots.umap %}
            <div class="image-card">
                <h4>UMAP Embedding</h4>
                <img src="{{ plots.umap }}" alt="UMAP Embedding">
                <p>2D projection of joint embeddings</p>
            </div>
            {% endif %}

            {% if plots.retrieval %}
            <div class="image-card">
                <h4>Retrieval Curves</h4>
                <img src="{{ plots.retrieval }}" alt="Retrieval Curves">
                <p>Cross-modal retrieval performance</p>
            </div>
            {% endif %}

            {% if plots.gradcam %}
            <div class="image-card">
                <h4>Grad-CAM Visualization</h4>
                <img src="{{ plots.gradcam }}" alt="Grad-CAM">
                <p>Visual attention maps</p>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Experimental Details -->
    <div class="section">
        <h2>⚙️ Experimental Setup</h2>
        
        <h3>Training Configuration</h3>
        <div class="metadata">
            <strong>Optimizer:</strong> {{ training.optimizer.name }}<br>
            <strong>Learning Rate:</strong> {{ training.optimizer.lr }}<br>
            <strong>Batch Size:</strong> {{ training.batch_size }}<br>
            <strong>Max Epochs:</strong> {{ training.max_epochs }}<br>
            <strong>Device:</strong> {{ training.device }}<br>
            <strong>Random Seed:</strong> {{ training.seed }}
        </div>

        <h3>Evaluation Metrics</h3>
        <ul>
            <li><strong>AUROC:</strong> Area Under Receiver Operating Characteristic</li>
            <li><strong>AUPRC:</strong> Area Under Precision-Recall Curve</li>
            <li><strong>ECE:</strong> Expected Calibration Error</li>
            <li><strong>Bootstrap CI:</strong> 95% confidence intervals from 1000 bootstrap samples</li>
        </ul>
    </div>

    <!-- Links and Artifacts -->
    <div class="section">
        <h2>🔗 Links and Artifacts</h2>
        
        <div class="links">
            {% if mlflow_run_id %}
            <a href="{{ mlflow_run_url }}" target="_blank">📊 MLflow Run</a>
            {% endif %}
            <a href="{{ github_repo }}" target="_blank">💻 Source Code</a>
            {% if release_url %}
            <a href="{{ release_url }}" target="_blank">📦 Release</a>
            {% endif %}
            <a href="{{ dockerfile_url }}" target="_blank">🐳 Docker Image</a>
        </div>

        <h3>Reproducibility</h3>
        <div class="metadata">
            <strong>Git Repository:</strong> {{ github_repo }}<br>
            <strong>Git SHA:</strong> {{ git_sha }}<br>
            <strong>Version:</strong> {{ version }}<br>
            <strong>Python:</strong> {{ python_version }}<br>
            <strong>PyTorch:</strong> {{ torch_version }}<br>
            {% if mlflow_run_id %}
            <strong>MLflow Run ID:</strong> {{ mlflow_run_id }}
            {% endif %}
        </div>
    </div>

    <div class="footer">
        <p>Generated by histo-omics-lite {{ version }} | 
           <a href="https://github.com/altalanta/histo-omics-lite">GitHub</a> | 
           <a href="mailto:engineering@altalanta.ai">Contact</a>
        </p>
    </div>
</body>
</html>